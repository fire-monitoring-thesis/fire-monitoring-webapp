<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Analytics - Fire Alarm System</title>
  <link rel="stylesheet" href="/styles/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
</head>
<body>
  <!-- Toggle Button -->
  <button id="toggleBtn"></button>

  <!-- Sidebar container -->
  <div id="sidebar-container"></div>

  <!-- Main Content -->
  <main id="main-content">
    <h1>ðŸ“Š Sensor Analytics Dashboard</h1>

    <!-- Filters grouped -->
    <div class="filters-group compact" aria-label="Sensor analytics filters">
      <div class="filter-item stretch">
        <label for="deviceId">Device:</label>
        <select id="deviceId"><option value="">All Devices</option></select>
      </div>
      <div class="filter-item">
        <label for="startDate">Start Date:</label>
        <input type="date" id="startDate">
      </div>
      <div class="filter-item">
        <label for="endDate">End Date:</label>
        <input type="date" id="endDate">
      </div>
      <div class="filter-item action">
        <button id="applyFilters" class="btn btn-primary btn-compact">Apply Filters</button>
      </div>
    </div>

    <!-- KPI cards -->
    <div class="kpi-container">
      <div class="kpi-card"><h3>Total Alerts</h3><p id="total-alerts">0</p></div>
      <div class="kpi-card"><h3>Active Devices</h3><p id="active-devices">0</p></div>
      <div class="kpi-card"><h3>Max Alert Level</h3><p id="max-alert-level">0</p></div>
    </div>

    <!-- Chart -->
    <div class="chart-block">
      <h2>ðŸ“ˆ Sensor Readings</h2>
      <canvas id="sensorChart"></canvas>
    </div>
  </main>

  <!-- Load sidebar & auth -->
  <script src="/protected/script.js"></script>

  <!-- Page-specific JS -->
  <script>
    // --- Sidebar highlight and toggle ---
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        const toggleBtn = document.getElementById('toggleBtn');
        const sidebar = document.getElementById('sidebar');
        const main = document.getElementById('main-content');

        if (toggleBtn && sidebar && main) {
          let sidebarVisible = true;
          toggleBtn.style.left = '280px';

          toggleBtn.addEventListener('click', () => {
            if (sidebarVisible) {
              sidebar.style.transform = 'translateX(-260px)';
              main.style.marginLeft = '0';
              toggleBtn.style.left = '1rem';
            } else {
              sidebar.style.transform = 'translateX(0)';
              main.style.marginLeft = '260px';
              toggleBtn.style.left = '280px';
            }
            sidebarVisible = !sidebarVisible;
          });

          // Highlight current page
          const currentPage = window.location.pathname;
          document.querySelectorAll('#sidebar a').forEach(link => {
            if (link.getAttribute('href') === currentPage) {
              link.classList.add('active');
            }
          });
        }
      }, 100);
    });

    // --- Analytics JS ---
    const totalAlertsEl = document.getElementById('total-alerts');
    const activeDevicesEl = document.getElementById('active-devices');
    const maxAlertLevelEl = document.getElementById('max-alert-level');
    const deviceSelect = document.getElementById('deviceId');
    const startDateEl = document.getElementById('startDate');
    const endDateEl = document.getElementById('endDate');
    const applyBtn = document.getElementById('applyFilters');

    let sensorChart = null;

    async function fetchDevices() {
      try {
        const res = await fetch('/api/analytics/devices');
        const data = await res.json();
        return Array.isArray(data) ? data : (data.devices || []);
      } catch(err) { console.error(err); return []; }
    }

    async function fetchData(device='', start='', end='') {
      try {
        let url = `/api/analytics?`;
        if(device) url += `m=${encodeURIComponent(device)}&`;
        if(start) url += `start=${start}&`;
        if(end) url += `end=${end}&`;

        const res = await fetch(url);
        if(!res.ok) throw new Error('Failed fetching data');
        const json = await res.json();
        return json.rows || [];
      } catch(err) {
        console.error(err);
        return [];
      }
    }

    function updateKPI(data){
      if(!data || !data.length){
        totalAlertsEl.textContent='0';
        activeDevicesEl.textContent='0';
        maxAlertLevelEl.textContent='0';
        return;
      }

      let totalAlerts=0, maxAlert=0;
      const devices = new Set();

      data.forEach(row=>{
        if(row.m) devices.add(row.m);
        const alertLevel=parseInt(row.alert_level)||0;
        maxAlert = Math.max(maxAlert, alertLevel);
        if(alertLevel>0) totalAlerts++;
      });

      totalAlertsEl.textContent = totalAlerts;
      activeDevicesEl.textContent = devices.size;
      maxAlertLevelEl.textContent = maxAlert;
    }

    function renderChart(data){
      const ctx = document.getElementById('sensorChart').getContext('2d');
      const labels = data.map(r => new Date(r.timestamp_window).toLocaleString());
      const flame = data.map(r => parseFloat(r.fa)||0);
      const flameB = data.map(r => parseFloat(r.fb)||0);
      const smoke = data.map(r => parseFloat(r.sa)||0);
      const smokeB = data.map(r => parseFloat(r.sb)||0);
      const temp = data.map(r => parseFloat(r.ta)||0);
      const tempB = data.map(r => parseFloat(r.tb)||0);
      const gasA = data.map(r => parseFloat(r.ga)||0);
      const gasB = data.map(r => parseFloat(r.gb)||0);

      if(sensorChart) sensorChart.destroy();

      sensorChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Flame A', data: flame, borderColor:'#EF4444', fill:true, backgroundColor:'rgba(239,68,68,0.2)', tension:0.3 },
            { label: 'Flame B', data: flameB, borderColor:'#B91C1C', fill:true, backgroundColor:'rgba(185,28,28,0.2)', tension:0.3 },
            { label: 'Smoke A', data: smoke, borderColor:'#F59E0B', fill:true, backgroundColor:'rgba(245,158,11,0.2)', tension:0.3 },
            { label: 'Smoke B', data: smokeB, borderColor:'#B45309', fill:true, backgroundColor:'rgba(180,83,9,0.2)', tension:0.3 },
            { label: 'Temp A', data: temp, borderColor:'#3B82F6', fill:true, backgroundColor:'rgba(59,130,246,0.2)', tension:0.3 },
            { label: 'Temp B', data: tempB, borderColor:'#1E40AF', fill:true, backgroundColor:'rgba(30,64,175,0.2)', tension:0.3 },
            { label: 'Gas A', data: gasA, borderColor:'#10B981', fill:true, backgroundColor:'rgba(16,185,129,0.2)', tension:0.3 },
            { label: 'Gas B', data: gasB, borderColor:'#047857', fill:true, backgroundColor:'rgba(4,120,87,0.2)', tension:0.3 }
          ]
        },
        options:{
          responsive:true,
          plugins:{
            legend:{ position:'top', labels:{usePointStyle:true} },
            tooltip:{ mode:'index', intersect:false },
            zoom:{ pan:{enabled:true, mode:'x'}, zoom:{enabled:true, mode:'x'} }
          },
          interaction:{ mode:'index', intersect:false },
          scales:{
            x:{ display:true, title:{display:true, text:'Time'} },
            y:{ display:true, title:{display:true, text:'Sensor Value'}, beginAtZero:true }
          }
        }
      });
    }

    async function loadAnalytics(){
      const device = deviceSelect.value;
      const start = startDateEl.value;
      const end = endDateEl.value;

      const data = await fetchData(device, start, end);
      updateKPI(data);
      renderChart(data);
    }

    async function initDevices(){
      const devices = await fetchDevices();
      deviceSelect.innerHTML='<option value="">All Devices</option>';
      devices.forEach(d=>{
        const id = typeof d==='string'?d:d.m||d.device_id||d;
        const opt = document.createElement('option');
        opt.value=id; opt.textContent=id;
        deviceSelect.appendChild(opt);
      });
    }

    applyBtn.addEventListener('click', loadAnalytics);

    document.addEventListener('DOMContentLoaded', async()=>{
      await initDevices();
      await loadAnalytics();
    });
  </script>
</body>
</html>
