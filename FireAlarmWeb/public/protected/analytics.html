<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Analytics - Fire Alarm System</title>
  <link rel="stylesheet" href="/styles/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #f5f5f5; margin:0; padding:0; }
    main { padding: 2rem; }
    .chart-block { background: #fff; padding: 1rem; margin-bottom: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    canvas { max-height: 400px; }
    .kpi-container { display: flex; gap: 1rem; margin: 1rem 0; flex-wrap: wrap; }
    .kpi-card { flex: 1 1 150px; background:#fff; padding:1rem; border-radius:12px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    .kpi-card h3 { margin-bottom:0.5rem; font-weight:600; }
    .device-select { margin:1rem 0; }
  </style>
</head>
<body>
  <button id="toggleBtn"></button>
  <div id="sidebar-container"></div>

  <main id="main-content">
    <h1>ðŸ“Š Analytics & Reports</h1>

    <div class="device-select">
      <label for="deviceId">Select Device:</label>
      <select id="deviceId">
        <option value="">All Devices</option>
      </select>
    </div>

    <div class="kpi-container">
      <div class="kpi-card"><h3>Total Alerts</h3><p id="total-alerts">0</p></div>
      <div class="kpi-card"><h3>Active Devices</h3><p id="active-devices">0</p></div>
      <div class="kpi-card"><h3>Max Alert Level</h3><p id="max-alert-level">0</p></div>
    </div>

    <div id="charts-container">
      <div class="chart-block"><h2>Hourly (Last 24h)</h2><canvas id="chart-hourly"></canvas></div>
      <div class="chart-block"><h2>Daily</h2><canvas id="chart-daily"></canvas></div>
      <div class="chart-block"><h2>Weekly</h2><canvas id="chart-weekly"></canvas></div>
      <div class="chart-block"><h2>Monthly</h2><canvas id="chart-monthly"></canvas></div>
      <div class="chart-block"><h2>Yearly</h2><canvas id="chart-yearly"></canvas></div>
    </div>
  </main>

<script>
const totalAlertsEl = document.getElementById('total-alerts');
const activeDevicesEl = document.getElementById('active-devices');
const maxAlertLevelEl = document.getElementById('max-alert-level');
const deviceSelect = document.getElementById('deviceId');

const chartIds = ['hourly', 'daily', 'weekly', 'monthly', 'yearly'];
const charts = {};

// Fetch analytics data
async function fetchAnalytics(range='daily', device='') {
  try {
    let url = '';
    if(range==='hourly') url = `/api/analytics/hourly`;
    else url = `/api/analytics?range=${range}`;
    if(device) url += `&m=${encodeURIComponent(device)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const data = await res.json();
    return data.rows || [];
  } catch(err) {
    console.error(err);
    return [];
  }
}

// Fetch devices list
async function fetchDevices() {
  try {
    const res = await fetch('/api/analytics/devices');
    const data = await res.json();
    if (Array.isArray(data)) return data;
    if (data.devices && Array.isArray(data.devices)) return data.devices;
    return [];
  } catch(err){ console.error(err); return [];}
}

// Update KPI cards
function updateKPI(data){
  if(!data || data.length===0){
    totalAlertsEl.textContent='0';
    activeDevicesEl.textContent='0';
    maxAlertLevelEl.textContent='0';
    return;
  }
  let totalAlerts=0, maxAlert=0;
  const devices = new Set();
  data.forEach(row=>{
    if(row.m) devices.add(row.m);
    const alertLevel=parseInt(row.max_alert_level)||0;
    maxAlert=Math.max(maxAlert,alertLevel);
    if(alertLevel>0) totalAlerts++;
  });
  totalAlertsEl.textContent=totalAlerts;
  activeDevicesEl.textContent=devices.size;
  maxAlertLevelEl.textContent=maxAlert;
}

// Format labels based on range
function formatLabels(data, range){
  return data.map(r=>{
    const dt = new Date(r.timestamp_window);
    switch(range){
      case 'hourly': return dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      case 'daily': return dt.toLocaleDateString([], {month:'short', day:'numeric'});
      case 'weekly': return `W${getWeekNumber(dt)}-${dt.getFullYear()}`;
      case 'monthly': return dt.toLocaleDateString([], {month:'short', year:'numeric'});
      case 'yearly': return dt.getFullYear();
      default: return dt.toLocaleString();
    }
  });
}

// Helper: Get ISO week number
function getWeekNumber(d){
  const date = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const dayNum = date.getDay() || 7;
  date.setDate(date.getDate() + 4 - dayNum);
  const yearStart = new Date(date.getFullYear(),0,1);
  return Math.ceil((((date - yearStart)/86400000) + 1)/7);
}

// Render a chart
function renderChart(canvasId, data, range){
  const ctx=document.getElementById(canvasId);
  if(!ctx) return;

  const labels = formatLabels(data, range);
  const flame = data.map(r=>parseFloat(r.avg_fa)||0);
  const smoke = data.map(r=>parseFloat(r.avg_sa)||0);
  const temperature = data.map(r=>parseFloat(r.avg_ta)||0);

  if(charts[canvasId]) charts[canvasId].destroy();

  charts[canvasId]=new Chart(ctx.getContext('2d'),{
    type:'line',
    data:{ labels, datasets:[
      { label:'Flame', data:flame, borderColor:'#EF4444', backgroundColor:'rgba(239,68,68,0.2)', fill:true, tension:0.3, pointRadius:2 },
      { label:'Smoke', data:smoke, borderColor:'#F59E0B', backgroundColor:'rgba(245,158,11,0.2)', fill:true, tension:0.3, pointRadius:2 },
      { label:'Temperature', data:temperature, borderColor:'#3B82F6', backgroundColor:'rgba(59,130,246,0.2)', fill:true, tension:0.3, pointRadius:2 }
    ]},
    options:{
      responsive:true,
      plugins:{
        legend:{ position:'top' },
        tooltip:{ mode:'index', intersect:false },
        zoom:{ 
          pan:{ enabled:true, mode:'x' },
          zoom:{ enabled:true, mode:'x' }
        }
      },
      interaction:{ mode:'index', intersect:false },
      scales:{
        x:{ display:true, title:{ display:true, text:'Time' } },
        y:{ display:true, title:{ display:true, text:'Sensor Value' }, beginAtZero:true }
      }
    }
  });
}

// Load all charts
async function loadAllCharts(device=''){
  for(const range of chartIds){
    const data = await fetchAnalytics(range, device);
    renderChart(`chart-${range}`, data, range);
    if(range==='daily') updateKPI(data);
  }
}

// Initialize devices dropdown
async function initDevices(){
  const devices = await fetchDevices();
  deviceSelect.innerHTML='<option value="">All Devices</option>';
  devices.forEach(d=>{
    const deviceId = typeof d==='string'?d:(d.m||d.device_id||d);
    const opt=document.createElement('option');
    opt.value=deviceId; opt.textContent=deviceId;
    deviceSelect.appendChild(opt);
  });
  deviceSelect.addEventListener('change',()=>loadAllCharts(deviceSelect.value));
}

// Initialize page
document.addEventListener('DOMContentLoaded', async()=>{
  await initDevices();
  await loadAllCharts();

  // Sidebar toggle
  const toggleBtn=document.getElementById('toggleBtn');
  const sidebar=document.getElementById('sidebar-container');
  const main=document.getElementById('main-content');
  if(toggleBtn&&sidebar&&main){
    let visible=true;
    toggleBtn.style.left='280px';
    toggleBtn.addEventListener('click',()=>{
      if(visible){ sidebar.style.transform='translateX(-260px)'; main.style.marginLeft='0'; toggleBtn.style.left='1rem'; }
      else{ sidebar.style.transform='translateX(0)'; main.style.marginLeft='260px'; toggleBtn.style.left='280px'; }
      visible=!visible;
    });
  }
});
</script>
</body>
</html>
