<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - Fire Alarm System</title>
  <link rel="stylesheet" href="/styles/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Toggle Button -->
  <button id="toggleBtn"></button>

  <!-- Sidebar container -->
  <div id="sidebar-container"></div>

  <!-- Main Content -->
  <main id="main-content">
    <h1>üî• Fire Monitoring Dashboard</h1>

    <!-- Quick Stats -->
    <div class="stats-grid">
      <div class="stat-card green">
        <div class="stat-number" id="active-devices-stat">-</div>
        <div class="stat-label">Active Devices</div>
      </div>
      <div class="stat-card blue">
        <div class="stat-number" id="today-alerts-stat">-</div>
        <div class="stat-label">Today's Alerts</div>
      </div>
      <div class="stat-card orange">
        <div class="stat-number" id="system-uptime-stat">-</div>
        <div class="stat-label">System Uptime</div>
      </div>
      <div class="stat-card purple">
        <div class="stat-number" id="total-locations-stat">-</div>
        <div class="stat-label">Total Locations</div>
      </div>
    </div>

    <!-- System Status Banner -->
    <div class="status-banner">
      <div class="status-indicator">
        <div class="status-light" id="status-light-indicator"></div>
        <div class="status-info">
          <h3 id="system-status-text">System Status: Loading...</h3>
          <p id="system-status-desc">Loading system information...</p>
        </div>
      </div>
      <div class="last-update">
        <span>Last updated: <strong id="last-update-time">Loading...</strong></span>
      </div>
    </div>

    <!-- Current Reading Warning Table -->
    <div class="iframe-container">
      <div class="iframe-box full-width">
        <h3>üî• Current Reading Warning Table</h3>
        <iframe 
          src="https://firealarmsystem.grafana.net/d-solo/fikv8s4/text-test?orgId=1&from=1761185255753&to=1761185555753&timezone=browser&refresh=5s&theme=light&panelId=1&__feature.dashboardSceneSolo=true" 
          width="100%" 
          height="300" 
          frameborder="0">
        </iframe>
      </div>
    </div>

    <!-- Realtime Map - Full Width with Emphasis -->
    <div class="map-section">
      <h2>üó∫Ô∏è Realtime Location Map Monitoring</h2>
      <p class="map-description">Live monitoring of all fire alarm devices with location-based warnings and alerts</p>
      <div class="iframe-box full-width map-container">
        <iframe src="http://grafana:3000/d-solo/ad7lvst/new-dashboard?orgId=1&from=1763086972165&to=1763108572165&timezone=browser&panelId=panel-1&__feature.dashboardSceneSolo=true" width="450" height="200" frameborder="0"></iframe>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="activity-section">
      <h2>üö® Recent System Activity</h2>
      <div class="activity-box">
        <div class="activity-header">
          <h3>Latest Status</h3>
          <span class="status-badge" id="activity-badge">Loading...</span>
        </div>
        <div class="activity-content">
          <p id="activity-line-1">Loading activity data...</p>
          <p id="activity-line-2">Please wait...</p>
          <p id="activity-line-3">üì° Last sync: Loading...</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Load auth script -->
  <script src="/protected/script.js"></script>

  <!-- Page-specific functionality -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        const toggleBtn = document.getElementById('toggleBtn');
        const sidebar = document.getElementById('sidebar');
        const main = document.getElementById('main-content');

        if (toggleBtn && sidebar && main) {
          let sidebarVisible = true;
          toggleBtn.style.left = '280px';

          toggleBtn.addEventListener('click', () => {
            if (sidebarVisible) {
              sidebar.style.transform = 'translateX(-260px)';
              main.style.marginLeft = '0';
              toggleBtn.style.left = '1rem';
            } else {
              sidebar.style.transform = 'translateX(0)';
              main.style.marginLeft = '260px';
              toggleBtn.style.left = '280px';
            }
            sidebarVisible = !sidebarVisible;
          });

          // Highlight current page
          const currentPage = window.location.pathname;
          document.querySelectorAll('#sidebar a').forEach(link => {
            if (link.getAttribute('href') === currentPage) {
              link.classList.add('active');
            }
          });
        }
      }, 100);

      // Load dashboard statistics
      async function loadDashboardStats() {
        try {
          const res = await fetch('/api/dashboard/stats');
          const data = await res.json();
          
          document.getElementById('active-devices-stat').textContent = data.activeDevices || 0;
          document.getElementById('today-alerts-stat').textContent = data.todayAlerts || 0;
          document.getElementById('system-uptime-stat').textContent = data.systemUptime || '0%';
          document.getElementById('total-locations-stat').textContent = data.totalLocations || 0;
        } catch (err) {
          console.error('Error loading dashboard stats:', err);
        }
      }

      // Load dashboard status
      async function loadDashboardStatus() {
        try {
          const res = await fetch('/api/dashboard/status');
          const data = await res.json();
          
          // Update system status
          const statusText = document.getElementById('system-status-text');
          const statusDesc = document.getElementById('system-status-desc');
          const statusLight = document.getElementById('status-light-indicator');
          const lastUpdate = document.getElementById('last-update-time');
          
          statusText.textContent = `System Status: ${data.systemStatus || 'Unknown'}`;
          statusDesc.textContent = data.systemStatus === 'Operational' 
            ? 'All monitoring systems are functioning normally'
            : data.systemStatus === 'Warning'
            ? 'Some devices are reporting warnings'
            : 'Critical alerts detected - immediate attention required';
          
          // Update status light color
          statusLight.className = 'status-light';
          if (data.systemStatus === 'Operational') {
            statusLight.classList.add('green');
          } else if (data.systemStatus === 'Warning') {
            statusLight.classList.add('yellow');
          } else if (data.systemStatus === 'Critical') {
            statusLight.classList.add('red');
          }
          
          lastUpdate.textContent = data.lastUpdate || 'Unknown';
          
          // Update activity section
          const activityBadge = document.getElementById('activity-badge');
          activityBadge.className = 'status-badge';
          if (data.systemStatus === 'Operational') {
            activityBadge.classList.add('normal');
            activityBadge.textContent = 'All Systems Normal';
          } else if (data.systemStatus === 'Warning') {
            activityBadge.classList.add('warning');
            activityBadge.textContent = 'Warning Status';
          } else {
            activityBadge.classList.add('critical');
            activityBadge.textContent = 'Critical Alert';
          }
          
          document.getElementById('activity-line-1').textContent = `‚úÖ ${data.recentActivity || 'System check in progress'}`;
          document.getElementById('activity-line-2').textContent = `‚úÖ ${data.activityDetails || 'Checking devices...'}`;
          document.getElementById('activity-line-3').textContent = `üì° Last sync: ${data.lastUpdate || 'Unknown'}`;
        } catch (err) {
          console.error('Error loading dashboard status:', err);
        }
      }

      // Load all dashboard data
      async function loadDashboardData() {
        await Promise.all([loadDashboardStats(), loadDashboardStatus()]);
      }

      // Initial load
      loadDashboardData();

      // Auto-refresh every 5 minutes (300000ms)
      setInterval(loadDashboardData, 300000);
    });
  </script>
</body>
</html>