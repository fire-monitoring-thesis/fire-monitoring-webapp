<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - Fire Alarm System</title>
  <link rel="stylesheet" href="/styles/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Toggle Button -->
  <button id="toggleBtn"></button>

  <!-- Sidebar container -->
  <div id="sidebar-container"></div>

  <!-- Main Content -->
  <main id="main-content">
    <h1>ğŸ”¥ Fire Monitoring Dashboard</h1>

    <!-- Quick Stats -->
    <div class="stats-grid">
      <div class="stat-card green">
        <div class="stat-number" id="active-devices-stat">-</div>
        <div class="stat-label">Active Devices</div>
      </div>
      <div class="stat-card blue">
        <div class="stat-number" id="today-alerts-stat">-</div>
        <div class="stat-label">Today's Alerts</div>
      </div>
      <div class="stat-card orange">
        <div class="stat-number" id="system-uptime-stat">-</div>
        <div class="stat-label">System Uptime</div>
      </div>
      <div class="stat-card purple">
        <div class="stat-number" id="total-locations-stat">-</div>
        <div class="stat-label">Total Locations</div>
      </div>
    </div>

    <!-- System Status Banner -->
    <div class="status-banner">
      <div class="status-indicator">
        <div class="status-light" id="status-light-indicator"></div>
        <div class="status-info">
          <h3 id="system-status-text">System Status: Loading...</h3>
          <p id="system-status-desc">Loading system information...</p>
        </div>
      </div>
      <div class="last-update">
        <span>Last updated: <strong id="last-update-time">Loading...</strong></span>
      </div>
    </div>

    <!-- Panels Container -->
    <div class="panels-container" style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 2rem;">

      <!-- Barangay Map Panel (Geomap, Portrait, Big) -->
      <div class="panel geomap" style="flex: 2; min-width: 400px;">
        <h3>ğŸ—ºï¸ Barangay Map</h3>
        <div class="iframe-box">
          <iframe id="barangayMapPanel"
                  src="http://localhost:3000/d-solo/adxfst2/barangay-map?orgId=1&from=1763520157797&to=1763541757797&timezone=browser&panelId=panel-1&__feature.dashboardSceneSolo=true"
                  width="100%" height="600" frameborder="0"></iframe>
        </div>
      </div>

      <!-- Status Panel (Landscape, Smaller) -->
      <div class="panel status" style="flex: 1; min-width: 300px;">
        <h3>ğŸ“Š Alert Status Table</h3>
        <div class="iframe-box">
          <iframe id="alertStatusPanel"
                  src="http://localhost:3000/d-solo/addhfdw/alert-status-level?orgId=1&from=1763520076878&to=1763541676878&timezone=browser&theme=light&panelId=panel-1&__feature.dashboardSceneSolo=true"
                  width="100%" height="300" frameborder="0"></iframe>
        </div>
      </div>

    </div>

    <!-- Recent Activity -->
    <div class="activity-section">
      <h2>ğŸš¨ Recent System Activity</h2>
      <div class="activity-box">
        <div class="activity-header">
          <h3>Latest Status</h3>
          <span class="status-badge" id="activity-badge">Loading...</span>
        </div>
        <div class="activity-content">
          <p id="activity-line-1">Loading activity data...</p>
          <p id="activity-line-2">Please wait...</p>
          <p id="activity-line-3">ğŸ“¡ Last sync: Loading...</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Load auth script -->
  <script src="/protected/script.js"></script>

  <!-- Panel Fallback Script -->
  <script>
    ['barangayMapPanel','alertStatusPanel'].forEach(id => {
      const iframe = document.getElementById(id);
      iframe.onload = () => console.log(`${id} loaded successfully`);
      iframe.onerror = () => {
        iframe.style.display = 'none';
        const msg = document.createElement('p');
        msg.textContent = `Grafana panel "${id}" is unavailable in local development.`;
        iframe.parentNode.appendChild(msg);
      };
    });
  </script>

  <!-- Page-specific functionality -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Sidebar toggle & highlight logic
      setTimeout(() => {
        const toggleBtn = document.getElementById('toggleBtn');
        const sidebar = document.getElementById('sidebar');
        const main = document.getElementById('main-content');
        if (toggleBtn && sidebar && main) {
          let sidebarVisible = true;
          toggleBtn.style.left = '280px';
          toggleBtn.addEventListener('click', () => {
            if (sidebarVisible) {
              sidebar.style.transform = 'translateX(-260px)';
              main.style.marginLeft = '0';
              toggleBtn.style.left = '1rem';
            } else {
              sidebar.style.transform = 'translateX(0)';
              main.style.marginLeft = '260px';
              toggleBtn.style.left = '280px';
            }
            sidebarVisible = !sidebarVisible;
          });
          const currentPage = window.location.pathname;
          document.querySelectorAll('#sidebar a').forEach(link => {
            if (link.getAttribute('href') === currentPage) link.classList.add('active');
          });
        }
      }, 100);

      // Dashboard stats and status functions here (keep your existing fetch logic)
      async function loadDashboardData() {
        // ... existing loadDashboardStats() and loadDashboardStatus() logic
      }
      loadDashboardData();
      setInterval(loadDashboardData, 300000); // Refresh every 5 mins
    });
  </script>
</body>
</html>
