<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Incident Logs - Fire Alarm System</title>
  <link rel="stylesheet" href="/styles/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <button id="toggleBtn"></button>
  <div id="sidebar-container"></div>

  <main id="main-content">
    <h1>üìã Incident Logs</h1>

    <!-- Filters -->
    <div class="device-select" style="margin-bottom: 2rem;">
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
        <div>
          <label for="filterDevice">Filter by Device:</label>
          <select id="filterDevice">
            <option value="">All Devices</option>
          </select>
        </div>
        <div>
          <label for="filterStartDate">Start Date:</label>
          <input type="date" id="filterStartDate">
        </div>
        <div>
          <label for="filterEndDate">End Date:</label>
          <input type="date" id="filterEndDate">
        </div>
        <div>
          <button class="btn btn-primary" onclick="loadIncidents()">Apply Filters</button>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="time-filters" style="margin-bottom: 2rem;">
      <button data-tab="pending" class="active" onclick="switchTab('pending')">Pending Verification</button>
      <button data-tab="verified" onclick="switchTab('verified')">Verified Incidents</button>
    </div>

    <!-- Pending Incidents Section -->
    <div id="pending-section">
      <h2>‚è≥ Pending Verification</h2>
      <div id="pending-incidents-container">
        <div class="loading-content">
          <div class="loading-spinner"></div>
          <div class="loading-text">Loading incidents...</div>
        </div>
      </div>
    </div>

    <!-- Verified Incidents Section -->
    <div id="verified-section" style="display: none;">
      <h2>‚úÖ Verified Incidents</h2>
      <div id="verified-incidents-container">
        <div class="loading-content">
          <div class="loading-spinner"></div>
          <div class="loading-text">Loading incidents...</div>
        </div>
      </div>
    </div>
  </main>

  <script src="/protected/script.js"></script>

  <script>
    let currentUserRole = null;
    let devices = [];

    // Get current user role
    async function getCurrentUser() {
      try {
        const res = await fetch('/auth/session');
        if (res.ok) {
          const data = await res.json();
          currentUserRole = data.role;
        }
      } catch (err) {
        console.error('Error fetching user:', err);
      }
    }

    // Fetch devices for filter
    async function fetchDevices() {
      try {
        const res = await fetch('/api/analytics/devices');
        const data = await res.json();
        devices = data.devices || [];
        
        const select = document.getElementById('filterDevice');
        devices.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.m;
          opt.textContent = d.m;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error('Error fetching devices:', err);
      }
    }

    // Load incidents
    async function loadIncidents() {
      const device = document.getElementById('filterDevice').value;
      const startDate = document.getElementById('filterStartDate').value;
      const endDate = document.getElementById('filterEndDate').value;

      const params = new URLSearchParams();
      if (device) params.append('device', device);
      if (startDate) params.append('startDate', startDate);
      if (endDate) params.append('endDate', endDate);

      try {
        const res = await fetch(`/api/incidents?${params.toString()}`);
        const data = await res.json();

        renderPendingIncidents(data.pending || []);
        renderVerifiedIncidents(data.verified || []);
      } catch (err) {
        console.error('Error loading incidents:', err);
        document.getElementById('pending-incidents-container').innerHTML = 
          '<div class="error-message">Failed to load incidents. Please try again.</div>';
      }
    }

    // Render pending incidents
    function renderPendingIncidents(incidents) {
      const container = document.getElementById('pending-incidents-container');
      
      if (incidents.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><div class="empty-state-title">No Pending Incidents</div><div class="empty-state-description">All incidents have been verified or there are no active alerts.</div></div>';
        return;
      }

      const isAdmin = currentUserRole === 'admin';
      
      container.innerHTML = `
        <div class="activity-box">
          <div class="activity-header">
            <h3>Pending Incidents (${incidents.length})</h3>
          </div>
          <div class="activity-content" style="padding: 0;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: var(--neutral-50); border-bottom: 2px solid var(--neutral-200);">
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">Device ID</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">Timestamp</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">Alert Level</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">Flame</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">Smoke</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">Temperature</th>
                  ${isAdmin ? '<th style="padding: 1rem; text-align: left; font-weight: 600;">Action</th>' : ''}
                </tr>
              </thead>
              <tbody>
                ${incidents.map(incident => `
                  <tr style="border-bottom: 1px solid var(--neutral-200);">
                    <td style="padding: 1rem;">${incident.device_id || 'N/A'}</td>
                    <td style="padding: 1rem;">${new Date(incident.timestamp).toLocaleString()}</td>
                    <td style="padding: 1rem;">
                      <span class="status-badge ${incident.alert_level >= 3 ? 'critical' : incident.alert_level > 0 ? 'warning' : 'normal'}">
                        Level ${incident.alert_level}
                      </span>
                    </td>
                    <td style="padding: 1rem;">${incident.flame_value?.toFixed(2) || 'N/A'}</td>
                    <td style="padding: 1rem;">${incident.smoke_value?.toFixed(2) || 'N/A'}</td>
                    <td style="padding: 1rem;">${incident.temp_value?.toFixed(2) || 'N/A'}</td>
                    ${isAdmin ? `
                      <td style="padding: 1rem;">
                        <button class="btn btn-primary" onclick="verifyIncident('${incident.device_id}', '${incident.timestamp}', ${incident.alert_level}, ${incident.flame_value || 0}, ${incident.smoke_value || 0}, ${incident.temp_value || 0})">
                          Verify
                        </button>
                      </td>
                    ` : ''}
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // Render verified incidents
    function renderVerifiedIncidents(incidents) {
      const container = document.getElementById('verified-incidents-container');
      
      if (incidents.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-title">No Verified Incidents</div><div class="empty-state-description">No incidents have been verified yet.</div></div>';
        return;
      }

      container.innerHTML = `
        <div class="activity-box">
          <div class="activity-header">
            <h3>Verified Incidents (${incidents.length})</h3>
          </div>
          <div class="activity-content" style="padding: 0;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: var(--neutral-50); border-bottom: 2px solid var(--neutral-200);">
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">Device ID</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">Incident Time</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">Alert Level</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">Flame</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">Smoke</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">Temperature</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">Verified By</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">Verified At</th>
                </tr>
              </thead>
              <tbody>
                ${incidents.map(incident => `
                  <tr style="border-bottom: 1px solid var(--neutral-200);">
                    <td style="padding: 1rem;">${incident.device_id || 'N/A'}</td>
                    <td style="padding: 1rem;">${new Date(incident.timestamp).toLocaleString()}</td>
                    <td style="padding: 1rem;">
                      <span class="status-badge ${incident.alert_level >= 3 ? 'critical' : incident.alert_level > 0 ? 'warning' : 'normal'}">
                        Level ${incident.alert_level}
                      </span>
                    </td>
                    <td style="padding: 1rem;">${incident.flame_value?.toFixed(2) || 'N/A'}</td>
                    <td style="padding: 1rem;">${incident.smoke_value?.toFixed(2) || 'N/A'}</td>
                    <td style="padding: 1rem;">${incident.temp_value?.toFixed(2) || 'N/A'}</td>
                    <td style="padding: 1rem;">${incident.verified_by_username || 'N/A'}</td>
                    <td style="padding: 1rem;">${new Date(incident.verified_at).toLocaleString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // Verify incident
    async function verifyIncident(deviceId, timestamp, alertLevel, flameValue, smokeValue, tempValue) {
      if (!confirm('Are you sure you want to verify this incident? This will save it to the verified incidents database.')) {
        return;
      }

      try {
        const res = await fetch('/api/incidents/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            device_id: deviceId,
            timestamp: timestamp,
            alert_level: alertLevel,
            flame_value: flameValue,
            smoke_value: smokeValue,
            temp_value: tempValue,
            notes: ''
          })
        });

        const data = await res.json();
        
        if (res.ok) {
          alert('Incident verified successfully!');
          loadIncidents(); // Reload incidents
        } else {
          alert('Error: ' + (data.error || 'Failed to verify incident'));
        }
      } catch (err) {
        console.error('Error verifying incident:', err);
        alert('Failed to verify incident. Please try again.');
      }
    }

    // Switch tab
    function switchTab(tab) {
      document.querySelectorAll('.time-filters button').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.time-filters button[data-tab="${tab}"]`).classList.add('active');
      
      if (tab === 'pending') {
        document.getElementById('pending-section').style.display = 'block';
        document.getElementById('verified-section').style.display = 'none';
      } else {
        document.getElementById('pending-section').style.display = 'none';
        document.getElementById('verified-section').style.display = 'block';
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await getCurrentUser();
      await fetchDevices();
      await loadIncidents();

      // Auto-refresh every 5 minutes
      setInterval(loadIncidents, 300000);
    });
  </script>
</body>
</html>
